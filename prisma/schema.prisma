generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  role         Role      @default(DEVELOPER)
  name         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  tasks        Task[]
  auditLogs    AuditLog[]
  projects     Project[]
}

model Task {
  id              String       @id @default(uuid())
  title           String
  description     String?
  priority        Priority     @default(MEDIUM)
  status          Status       @default(NOT_STARTED)
  deadline        DateTime?
  assigneeId      String?
  assignee        User?        @relation(fields: [assigneeId], references: [id])
  projectId       String?
  project         Project?     @relation(fields: [projectId], references: [id])
  recurrenceType  RecurrenceType?
  orderIndex      Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Event {
  id          String    @id @default(uuid())
  title       String
  description String?
  type        EventType @default(DEVELOPMENT)
  startDate   DateTime
  endDate     DateTime
  progress    Int       @default(0) // 0-100 percentage
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model AuditLog {
  id           String      @id @default(uuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id])
  action       AuditAction
  resourceType String
  resourceId   String?
  details      Json?
  timestamp    DateTime    @default(now())
}

model Project {
  id                String    @id @default(uuid())
  name              String
  description       String?
  brief             String?   // Briefing simplificado
  detailedBrief     String?   // Briefing detallado/explayado
  drivePromptsUrl   String?   // URL al Drive con prompts
  driveN8nFlowUrl   String?   // URL al Drive con concepto del flujo n8n
  driveDashboardUrl String?   // URL al Drive con accesos del Dashboard
  ownerId           String
  owner             User      @relation(fields: [ownerId], references: [id])
  priority          Priority  @default(MEDIUM)
  orderIndex        Int       @default(0)
  status            ProjectStatus @default(ACTIVE)
  tasks             Task[]
  events            Event[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

enum Role {
  ADMIN
  DEVELOPER
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum Status {
  NOT_STARTED
  PENDING
  IN_PROGRESS
  DONE
}

enum EventType {
  DEVELOPMENT
  DELIVERY
  OTHER
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  OTHER
}

enum RecurrenceType {
  NONE
  DAILY
  WEEKLY
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}
